---
title: "Количественные финансы. Введение в R"
author: "Салихов Марсель (marcel.salikhov@gmail.com)"
date: "`r Sys.Date()`"
output:
  slidy_presentation:
    footer: НИУ ВШЭ. Салихов Марсель (marcel.salikhov@gmail.com)
    lib_dir: libs
    self_contained: no
---
   
## Цели лекции 
   
+ понять, что такое R и в чем его достоинства как инструмента количественного анализа
+ получить базовые представления о типах данных в R 
+ понять, что такое векторизация в R 


## Что такое R?

+ R -- язык программирования и платформа для статистического анализа, построения визуализаций (графиков) и много другого. К примеру, эта презентация сделана в R. 
+ R -- наиболее широко используемое в мире средство для статистического анализа 

## Почему именно R? 

+ R -- устоявшийся, достаточно простой и эффективный язык программирования. 
+ Выполнение аналитической задачи в форме кода имеет большие преимущества: проще автоматизировать выполнение сложных задач, проще находить ошибки, проще вспомнить потом, что же было сделано  
+ Reproducible research -- принцип проведения исследований в современном мире 
+ R имеет огромную экосистему дополнительного функционала (пакетов), которые расширяют базовые возможности. Практически все статистические методы, которые вы можете себе представить, имеют реализацию в R. 
+ R реализует один из лучших функционалов по построению графиков и визуалазиации данных. 

Этот график тоже построен в R 

```{r , echo = FALSE,warning=FALSE, message=FALSE}

library(plotly,  warn.conflicts = FALSE, quietly=TRUE)
z <- c(
  c(8.83,8.89,8.81,8.87,8.9,8.87),
  c(8.89,8.94,8.85,8.94,8.96,8.92),
  c(8.84,8.9,8.82,8.92,8.93,8.91),
  c(8.79,8.85,8.79,8.9,8.94,8.92),
  c(8.79,8.88,8.81,8.9,8.95,8.92),
  c(8.8,8.82,8.78,8.91,8.94,8.92),
  c(8.75,8.78,8.77,8.91,8.95,8.92),
  c(8.8,8.8,8.77,8.91,8.95,8.94),
  c(8.74,8.81,8.76,8.93,8.98,8.99),
  c(8.89,8.99,8.92,9.1,9.13,9.11),
  c(8.97,8.97,8.91,9.09,9.11,9.11),
  c(9.04,9.08,9.05,9.25,9.28,9.27),
  c(9,9.01,9,9.2,9.23,9.2),
  c(8.99,8.99,8.98,9.18,9.2,9.19),
  c(8.93,8.97,8.97,9.18,9.2,9.18)
)
dim(z) <- c(15,6)
z2 <- z + 1
z3 <- z - 1

p <- plot_ly(showscale = FALSE) %>%
  add_surface(z = ~z) %>%
  add_surface(z = ~z2, opacity = 0.98) %>%
  add_surface(z = ~z3, opacity = 0.98)


p
```


## Ограничения R

+ Кривая обучения -- печатать команды в текстовом виде, а не выполнять манипуляции мышью может показаться не очень удобным.
+ Многие задачи в R могут выполняться разными способами, разными функциями -- это запутывает. 
+ R все данные хранит в оперативной памяти. Объем данных для анализа ограничен памятью. 
+ R не очень хорошо подходит для высокоскоростных вычислений в промышленном использовании. 

## R и Excel 

+ Каждый инструмент -- для своих задач. Надо уметь работать с разными инструментами для того, чтобы решать поставленную задачу опимальным образом.  
+ Excel -- стандарт для выполнения простых и гибких задач. Если вам необходимо "посмотреть" на данные и "потрогать" их, то Excel -- лучший вариант. 
+ Excel  хорошо подходит для построения относительно несложных моделей. 

НО: 

+ Excel не дает работать с данными, даже относительно небольшими по современным стандартам. Попробуйте открыть в Excel файл, который содержит 100 тыс. строк и поработать с ним. 
+ В Excel можно строить сложные модели (и многие это делают!), но в таких моделях сложно найти ошибки (ошибки неизбежны) и поддерживать модели их. Известные примеры -- данные Reinhart & Rogoff, риск-менеджмент в JP Morgan. 
+ Excel по сути не поддерживает статистические вычисления и операции, кроме самых базовых  
+ В Excel сложно и неоптимально работать с финансовыми данными. 

## Установка R

1. Зайти на [CRAN](https://cran.r-project.org/) и установить R
2. Зайти на [RStudio](https://www.rstudio.com/) и установить R Studio -- более удобный и совершенный графический редактор для R

R можно установить и на Windows, на Mac OS -- разницы в функционале не будет. 
Для того, чтобы устанавливать пакеты необходимо иметь права администратора 

## Комманды в R

### Базовые операции

начнем с основ: 

```{r , echo = TRUE}
print("Hello world")

```

Сообщения, начинающиеся со знака # - показывают результат выывода в консоли R. 

R работает и как калькулятор. Можно складывать переменные: 

```{r, echo = TRUE}
1+3
```

умножать:

```{r, echo = TRUE}
2*3
```

делить: 
```{r, echo = TRUE}
6/2
```

брать квадратный корень: 

```{r, echo = TRUE}
sqrt(5)
```

брать логарифм

```{r, echo = TRUE}
log(5)
```

```{r, echo = TRUE}
2^10
```

## Типы данных 

Все в R -- объекты. Объекты могут быть разных типов и классов. Узнать тип объекта можно с помощью команды `type`, класс объекта -- командой `class`.
R оперирует именованными структурами данным. Каждый объект имеет свое имя. 
Числа могут быть разных типов.

```{r, echo = TRUE}
2^10
```

Ими могут быть, десятичные числа. Они называются `numeric` 

```{r, echo = TRUE}
x <- 10.5       # присвоить переменной x значение 10.5
x              # вывести значение x
class(x)       # тип переменной х 
```

Команды `=` и `<-` идентичны и означают "присвоить значение"
## Целые числа 

Тип `ingeger`
```{r, echo = TRUE}
x = as.integer(3)       # присвоить переменной x значение 3
x              # вывести значение x
class(x)       # тип переменной х 
is.integer(x)   # является ли x целым числом?
```

## Логические переменные 


```{r, echo = TRUE}
x = 1; y = 2   # sample values 
z = x > y 
z  
class(z)   
```

логические операции 

```{r, echo = TRUE}
u = TRUE; v = FALSE 
u & v          # u AND v 
u | v          # u OR v 
!u      
class(z)   
```

## Тип character 

`character` -- строковая переменная. 
В R объекты этого типа выделены кавычками 

```{r}
x = 1  # присвоить x численное значение 1 
y = '1' # присвоить y текстовое значение равное 1 
as.numeric(y) # преобразовать y в тип numeric 
## попробуйте команду x + y , будет сообщение об ошибке 

```

## Тип NA

Специальный тип для обозначения пропущенных данных (missing value) 
```{r}
x <- NA 
is.na(x)
is.na(c(1, NA))
```


## Вектор

Вектор -- тип данных, который состоит из упорядоченного набора объектов одного типа. 
Вектор можно создать с помощью команды `c` 

```{r}
a <- c(1, 2, 3)
b <- c(4,5,6)
is.vector(a) ## является ли a вектором

 n = c(2, 3, 5) 
 s = c("aa", "bb", "cc", "dd", "ee") 
 c(n, s) 

```

есть и другие варианты для создания векторов: 

```{r}
1:10
seq(from = 2, to = 10, by = 2)
seq(from= 1, by =2, length.out = 5)
rep(1:4,2)
rep(1:4, each = 2)
```


Операции могут выполняться и с векторами разной длины. В этом случае используется выравнивание векторов (recycling rule). 

```{r}
u = c(10, 20, 30) 
v = c(1, 2, 3, 4, 5, 6, 7, 8, 9) 
u + v 
```

У каждого вектора есть свой индекс (порядковый номер), к которому можно обратиться с помощью имени объекта (вектора) и квадратных скобок 

```{r}
s = c("aa", "bb", "cc", "dd", "ee") 
s[3] 
s[-3] # убрать третий элемент
s[10] 
```


## Векторизация операций

+ Преимущество R -- так называемая векторизация операций. Это означает, что вы можете осущесвлять операции над векторами, точно так же как и над отдельными числами. 
+ На самом деле любой единичный объект -- это вектор с длиной 1

```{r}
a 
b
a+b
a *b
log(a)

```

## Тип data frame

`data frame` -- это набор (коллекция) векторов, объединенных в один объект. Каждый столбец `data frame` -- вектор. Каждая строка -- наблюдение 

```{r}
str(mtcars) # посмотреть структуру объекта  
dim(mtcars) # размерность объекта, количество ноблюдней и переменных 
length(mtcars) # длина -- количество переменных 
head(mtcars) # первые 5 строк 
head(mtcars, n = 2) # first 2 rows of data.frame
tail(mtcars) # последние 5 строк 
tail(mtcars, n = 3) # last 3 rows of data.frame
```

Существуют разные способы обратиться к элементам `data frame`

К примеру, к отдельной колонке (переменной) можно обратиться следующими способами:
```{r}
mtcars[9] #  номер внутри двойных скобок
mtcars[[9]] #  номер внутри двойных скобок
mtcars$am
mtcars[, 'am']
```
к строкам можно обратиться следующими способами: 

```{r}
mtcars[24,] # индекс по номеру 
mtcars[c(3, 24),] 

L = mtcars$am == 0 
L
 mtcars[L,] 
```


## Тип Date

Тип `Date` представляет календарные даты.
Финансовые серии как правило представляют собой 

```{r}
date()
today <- Sys.Date()
today
format(today, "%d %b %Y")  # with month as a word
seq(today, length.out=10, by="1 week")
weekdays(today)
months(today)


```

можно делать конвертацию между типами `character` и `Date` c помощью функций `as.Date` и `as.character`

## Тип xts -- временной ряд 

В R есть несколько специальных типов данных для работы с временными рядами.
Один из них -- `xts` (extentible time series)

```{r}
#install.packages(xts) # установать пакет 
library(xts) #  загрузить пакет
data(sample_matrix)

df_xts <- as.xts(as.data.frame(sample_matrix),
                 important='very important info!')
str(df_xts)

xts(1:10, Sys.Date()+1:10)

head(index(df_xts))
head(coredata(df_xts))
```

основное удобство работы с объектами типа `xts` удобные способы получать подмножества исходного множества:

```{r}
df_xts['2007-01-06'] # отдельная дата 
df_xts['2007-03'] # отдельный месяц 

df_xts['/2007-01-07'] # Extract all the data from the beginning through January 7, 2007.

df_xts['2007-06-25/'] #Extract all the data from June 25, 2007 through the end.


```

